clear, clc

% x = [[ 0.43496536  2.03144707 -0.17122852 -0.9773247 ]; 
% [ 0.4755943   1.97653697 -0.19077501 -0.92810076];
% [ 0.51512504  1.91755234 -0.20933703 -0.87882009]; 
% [ 0.55347609  1.85489804 -0.22691343 -0.83002757]; 
% [ 0.59057405  1.78886245 -0.24351398 -0.78198878]; 
% [ 0.6263513   1.71966074 -0.25915376 -0.73479655]]';
sym x 

x(1,:) = [ 0.43496536  2.03144707 -0.17122852 -0.9773247 ];
x(2,:) = [ 0.4755943   1.97653697 -0.19077501 -0.92810076];
x(3,:) = [ 0.51512504  1.91755234 -0.20933703 -0.87882009];
x(4,:) = [ 0.55347609  1.85489804 -0.22691343 -0.83002757];
x(5,:) = [ 0.59057405  1.78886245 -0.24351398 -0.78198878];
x(6,:) = [ 0.6263513   1.71966074 -0.25915376 -0.73479655];

x = x';

x_star = [mean(x(1,1:5));
    mean(x(2,1:5));
    mean(x(3,1:5));
    mean(x(4,1:5))]

s_star = [x_star(1), x_star(3)]';
s_curr = [x(1,6), x(3,6)]';

pP = [[10.5601   12.6569];
     [12.6569   20.8321]];

safe_val = s_star'*pP*s_star

u = [17.29270317079948;
    16.50485306219421;
    15.697695722991114;
    14.869557174411534;
    14.019719931158146;
    13.14814813188159];

y(1,:) = x(1,:);
y(2,:) = x(2,:);
y(3,:) = x(3,:);
y(4,:) = x(4,:);
y(5,:) = u';

[n, N] = size(x);

Vx = [];

for i = 2:N
    for j = i+1:N
%         fprintf('%d, %d\n', i, j);
        x_diff = x(:,j) - x(:,i);
        Vx = [Vx, x_diff];
        
    end
end

Vy = [];

for i = 1:N-1
    for j = i+1:N-1
%         fprintf('%d, %d\n', i, j);
        y_diff = y(:,j) - y(:,i);
        Vy = [Vy, y_diff];
        
    end
end

Q = Vx * Vy';
P = Vy * Vy';

A_bar = Q * pinv(P);

A = A_bar(:,1:4);
B = A_bar(:,5);